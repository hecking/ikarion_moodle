// Generated by CoffeeScript 1.6.3
/* example metadata
  {
    "actor":
    {
      "objectType": "person",
      "id": "f25d7eff-8859-49ed-85e9-e7c1f92bc334",
      "displayName": "anonymized"
    },
    "target":
    {
      "objectType": "conceptMap",
      "id": "9383fbbe-e071-49b2-9770-46ddc4f8cd6e",
      "displayName": "unnamed concept map"
    },
    "generator":
    {
      "objectType": "application",
      "url": document.URL,
      "id": "04123e9e-14d0-447b-a851-805b9262d9a6",
      "displayName": "ut.tools.conceptmapper"
    },
    "provider":
    {
      "objectType": "ils",
      "url": "http://graasp.epfl.ch/metawidget/1/b387b6f...",
      "id": "0f8184db-53ba-4868-9208-896c3d7c25bb",
      "inquiryPhase": "orientation"
      "displayName": "name-of-ils"
    }
  }
*/


(function() {
  "use strict";
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.golab = window.golab || {};

  window.golab.ils = window.golab.ils || {};

  window.golab.ils.metadata = window.golab.ils.metadata || {};

  window.golab.ils.metadata.MetadataHandler = (function() {
    function MetadataHandler(metadata, cb) {
      var _this = this;
      console.log("Initializing MetadataHandler.");
      if (metadata) {
        this._metadata = JSON.parse(JSON.stringify(metadata));
      } else {
        throw "MetadataHandler needs an initial set of metadata at construction!";
      }
      setTimeout(function() {
        if (cb) {
          return cb(null, _this);
        }
      }, 0);
      console.log("using metadata:");
      console.log(this._metadata);
      this;
    }

    MetadataHandler.prototype.setMetadata = function(newMetadata) {
      var metadata = JSON.parse(JSON.stringify(newMetadata));
      this._metadata.provider = metadata.provider;    
      this._metadata.target = metadata.target;
      this._metadata.generator = metadata.generator;
      return this;
    };

    MetadataHandler.prototype.getMetadata = function() {
      return this._metadata;
    };

    MetadataHandler.prototype.setActor = function(newActor) {
      //return this._metadata.actor = newActor;
    };

    MetadataHandler.prototype.getActor = function() {
      return this._metadata.actor;
    };

    MetadataHandler.prototype.getTarget = function() {
      return this._metadata.target;
    };

    MetadataHandler.prototype.setTarget = function(newTarget) {
      return this._metadata.target = JSON.parse(JSON.stringify(newTarget));
    };

    MetadataHandler.prototype.getGenerator = function() {
      return this._metadata.generator;
    };

    MetadataHandler.prototype.getProvider = function() {
      return this._metadata.provider;
    };

    MetadataHandler.prototype.setTargetId = function(newId) {
      return this._metadata.target.id = newId;
    };

    MetadataHandler.prototype.setInstanceId = function(newId) {
      return this._metadata.provider.id = newId;
    };

    MetadataHandler.prototype.setGroupId = function(newId) {
      return this._metadata.actor.groupId = newId;
    };

    MetadataHandler.prototype.setUserId = function(newId) {
      return this._metadata.actor.id = newId;
    };

    MetadataHandler.prototype.setEditable = function(editable) {
      return this._metadata.actor.canEdit = editable;
    };

    MetadataHandler.prototype.setSession = function(key) {
      return this._metadata.provider.session = key;
    };

    MetadataHandler.prototype.setCloseTime = function(time) {
      return this._metadata.provider.timeclose = time;
    };

    MetadataHandler.prototype.setRole = function(role) {
      return this._metadata.actor.role = role;
    };

    MetadataHandler.prototype.setName = function(name) {
      return this._metadata.actor.name = (name.replace(/%20/g, " ")).trim();
      console.log(this.getName());
    };

    MetadataHandler.prototype.getInstanceId = function() {
      return this._metadata.provider.id;
    };

    MetadataHandler.prototype.getGroupId = function() {
      return this._metadata.actor.groupId;
    };

    MetadataHandler.prototype.getSession = function() {
      return this._metadata.provider.session;
    };

    MetadataHandler.prototype.getEditable = function() {
      return this._metadata.actor.canEdit=="true";
    };

    MetadataHandler.prototype.getUserId = function() {
      return this._metadata.actor.id;
    };

    MetadataHandler.prototype.getCloseTime = function() {
      return this._metadata.provider.timeclose;
    };

    MetadataHandler.prototype.getRole = function() {
      return this._metadata.actor.role;
    };

    MetadataHandler.prototype.getName = function() {
      return this._metadata.actor.name;
    };

    return MetadataHandler;

  })();

  window.golab.ils.metadata.GoLabMetadataHandler = (function(_super) {
    __extends(GoLabMetadataHandler, _super);

    function GoLabMetadataHandler(metadata, cb) {
      var error,
        _this = this;
      if (typeof osapi !== "undefined" && osapi !== null) {
        console.log("Retrieving metadata from osapi/ils.");
        try {
          if (!$.cookie) {
            throw "jquery.cookie library needs to be present before using the (GoLab)MetadataHandler (needed by ILS library).";
          }
          if (!ils) {
            throw "ILS library needs to be present before using the (GoLab)MetadataHandler.";
          }
          ils.getCurrentUser(function(userResult) {
            if (userResult.error) {
              console.warn("error reading username:");
              console.warn(userResult.error);
              metadata.actor.displayName = "unknown";
            } else {
              metadata.actor.displayName = userResult;
            }
            return ils.getIls(function(ilsSpace, phaseSpace) {
              var actorId;
              console.log("GoLab-MetadataHandler: ilsSpace, phaseSpace:");
              console.log(ilsSpace);
              console.log(phaseSpace);
              metadata.generator.url = gadgets.util.getUrlParameters().url;
              if (ilsSpace != null) {
                metadata.provider.objectType = ilsSpace.spaceType;
                metadata.provider.id = ilsSpace.objectId;
                metadata.provider.displayName = ilsSpace.displayName;
              }
              metadata.provider.url = ilsSpace.profileUrl;
              if (phaseSpace != null) {
                metadata.provider.inquiryPhase = phaseSpace.displayName;
              }
              actorId = metadata.actor.displayName + "@" + metadata.provider.id;
              metadata.actor.id = actorId;
              GoLabMetadataHandler.__super__.constructor.call(_this, metadata);
              return cb(null, _this);
            });
          });
        } catch (_error) {
          error = _error;
          console.warn("error during metadata retrieval:");
          console.warn(error);
        }
      } else {
        console.log("Running outside osapi/ils, using given metadata.");
        GoLabMetadataHandler.__super__.constructor.call(this, metadata);
        cb(null, this);
      }
    }

    return GoLabMetadataHandler;

  })(window.golab.ils.metadata.MetadataHandler);

  window.golab.ils.metadata.LocalMetadataHandler = (function(_super) {
    __extends(LocalMetadataHandler, _super);

    function LocalMetadataHandler(metadata, cb) {
      var actorId, getIdentifyingUrl, useNickname;
      getIdentifyingUrl = function() {
        var path, subPaths;
        path = window.location.pathname;
        subPaths = window.location.pathname.split("/");
        if (subPaths.length > 0) {
          switch (subPaths[0].toLocaleLowerCase()) {
            case "production":
              path = subPaths[0];
              break;
            case "experiments":
              path = subPaths[0];
              if (subPaths.length > 1) {
                path += "/" + subPaths[0];
              }
              break;
            default:
              path = "";
          }
        }
        return ("" + window.location.protocol + "//" + window.location.host + path).toLowerCase();
      };
      metadata.provider.id = getIdentifyingUrl();
      useNickname = localStorage.getItem('goLabNickName');
      if (!useNickname) {
        useNickname = "unknown user";
      }
      metadata.actor.displayName = useNickname;
      actorId = metadata.actor.displayName + "@" + metadata.provider.id;
      metadata.actor.id = actorId;
      LocalMetadataHandler.__super__.constructor.call(this, metadata);
      cb(null, this);
    }

    return LocalMetadataHandler;

  })(window.golab.ils.metadata.MetadataHandler);



    window.golab.ils.metadata.MoodleMetadataHandler = (function(_super) {
    __extends(MoodleMetadataHandler, _super);

    function MoodleMetadataHandler(metadata, cb) {
      var getIdentifyingUrl;
      getIdentifyingUrl = function() {
        var path, subPaths;
        path = window.location.pathname;
        subPaths = window.location.pathname.split("/");
        if (subPaths.length > 0) {
          switch (subPaths[0].toLocaleLowerCase()) {
            case "production":
              path = subPaths[0];
              break;
            case "experiments":
              path = subPaths[0];
              if (subPaths.length > 1) {
                path += "/" + subPaths[0];
              }
              break;
            default:
              path = "";
          }
        }
        return ("" + window.location.protocol + "//" + window.location.host + path).toLowerCase();
      };
      //metadata.provider.id = getIdentifyingUrl();
      //get the name of the moodle user (or the whole group?)
      MoodleMetadataHandler.__super__.constructor.call(this, metadata);
      cb(null, this);
    }

    return MoodleMetadataHandler;

  })(window.golab.ils.metadata.MetadataHandler);


}).call(this);

/*
//@ sourceMappingURL=MetadataHandler.map
*/
